# Nanopore m6A Detection Pipeline

Complete workflow for m6A modification detection from Nanopore sequencing data, covering the full analysis path from raw signal data to modification site identification.

## Overview

This pipeline implements complete analysis from Nanopore raw signal data (.pod5) to m6A modification site identification:

```
Raw signal (.pod5) → Basecalling → Alignment → Mm/MI tags → modkit analysis → m6A sites
```

### Pipeline Steps

| Step | Software | Input | Output | Description |
|------|----------|-------|--------|-------------|
| 1 | Dorado/Guppy | .pod5 | .fastq | Basecalling |
| 2 | Minimap2 | .fastq + genome | .bam | Sequence alignment |
| 3 | modkit | .bam | .csv | Modification detection |

## Directory Structure

```
m6a_detection_pipeline/
├── scripts/
│   ├── 01_basecalling.sh          # Basecalling
│   ├── 02_alignment.sh           # Sequence alignment
│   ├── 03_modkit_pileup.sh      # m6A modification analysis
│   └── run_full_pipeline.sh      # One-click execution
├── docs/
│   ├── 01_basecalling.md         # Basecalling details
│   ├── 02_alignment.md          # Alignment details
│   ├── 03_modkit.md             # modkit details
│   └── troubleshooting.md       # Troubleshooting
├── reference/                    # Reference genome
├── README.md
└── .gitignore
```

## Installation

### Method 1: Conda Environment (Recommended)

```bash
# Create environment
conda create -n m6a python=3.10
conda activate m6a

# Install core software
conda install -c conda-forge numpy pandas
conda install -c bioconda minimap2 samtools bedtools

# Install Dorado (ONT official)
# Download from: https://github.com/nanoporetech/dorado
# Or use container version
```

### Method 2: Docker/Singularity

```bash
# Use ONT official container
docker pull nanotechpore/dorado:0.8.1

# Or Singularity
singularity pull docker://nanotechpore/dorado:0.8.1
```

### Software Version Requirements

| Software | Minimum Version | Recommended Version |
|----------|-----------------|---------------------|
| Dorado | 0.7.0 | 0.8.1 |
| Guppy | 6.0.0 | 7.0.0 |
| minimap2 | 2.24 | 2.26 |
| samtools | 1.15 | 1.19 |
| modkit | 0.2.0 | 0.5.0 |

## Quick Start

### Complete Workflow

```bash
# Modify configuration parameters
vim scripts/run_full_pipeline.sh

# One-click execution
bash scripts/run_full_pipeline.sh

# Or run step by step
bash scripts/01_basecalling.sh
bash scripts/02_alignment.sh
bash scripts/03_modkit_pileup.sh
```

### Step-by-Step Execution

```bash
# Step 1: Basecalling
bash scripts/01_basecalling.sh \
    /path/to/reads.pod5 \
    /path/to/output/reads \
    dna_r10.4.1_e8.2_400bps_hac

# Step 2: Sequence alignment
bash scripts/02_alignment.sh \
    /path/to/reads.fastq \
    /path/to/reference/genome.fa \
    /path/to/output/aligned.bam

# Step 3: m6A modification analysis
bash scripts/03_modkit_pileup.sh \
    /path/to/aligned.bam \
    /path/to/reference/genome.fa \
    /path/to/output/m6A_sites.csv
```

## Input File Formats

### Raw Signal File (.pod5)

Nanopore sequencer-generated electrical signal data file.

**Format:**
- Extension: `.pod5`
- Content: Nanopore electrical signal intensity data
- Generated by: MinKNOW software or MinKNOW API

**Obtained from:**
- Directly from MinKNOW output directory
- Download from ONT Rerio database

```bash
# View file information
pod5 view --stats reads.pod5

# Count reads
pod5 count reads.pod5
```

### Reference Genome (.fa/.fasta)

Standard FASTA format reference genome sequence.

**Format Requirements:**
```
>chr1
ATGCGCTAGCTAGCTAGCTAGCTAGCTAGCTA...
>chr2
GCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA...
```

**Preparation Steps:**
```bash
# Create index
samtools faidx genome.fa

# Create mmi index (for minimap2)
minimap2 -d genome.fa.mmi genome.fa
```

## Output File Formats

### Basecalling Results (.fastq)

**Format:**
```
@read_id
ATCGATCGATCGATCGATCG
+
IIIIIIIIIIIIIIIIIIII
```

**Quality Scores:** Phred score format

### Alignment Results (.bam)

**Format:** Binary SAM format

**Key Tags:**
- `MM`: Modification base information (e.g., `MM:Z:m6A`)
- `ML`: Modification confidence score
- `MP`: Modification position information

```bash
# View modification tags
samtools view -e 'MM:Z:*' aligned.bam | head

# View m6A markers
samtools view aligned.bam | grep -o 'MM:Z:m6A[^,]*'
```

### m6A Modification Sites (.csv)

**Output Column Description:**

| Column | Description | Example |
|--------|-------------|---------|
| chrom | Chromosome | chr1 |
| start | Start position | 1234567 |
| end | End position | 1234568 |
| strand | Strand direction | + |
| mod_base | Modified base | m6A |
| freq | Modification frequency | 0.85 |
| coverage | Coverage | 150 |
| score | Confidence score | 25.5 |
| motif | Sequence motif | DRACH |

**Example:**
```
chrom,start,end,strand,mod_base,freq,coverage,score,motif
chr1,1234567,1234568,+,m6A,0.85,150,25.5,GGA
chr1,2345678,2345679,+,m6A,0.72,98,18.3,GGAC
```

## Script Details

### 01_basecalling.sh

Basecalling script, converts raw signals to sequences.

**Parameters:**
| Parameter | Description | Example |
|-----------|-------------|---------|
| `$1` | Input pod5 file/directory | `./reads/` |
| `$2` | Output directory | `./fastq/` |
| `$3` | Model name | `dna_r10.4.1_e8.2_400bps_hac` |

**Model Selection:**
- `dna_r10.4.1_e8.2_400bps_hac` - High accuracy (recommended)
- `dna_r10.4.1_e8.2_400bps_sup` - Ultra high accuracy
- `dna_r9.4.1_e8_hac` - R9.4.1 universal

**Enable Modification Detection:**
```bash
# Dorado (>=0.7.0)
dorado basecaller \
    --emit-moves \
    --mod-base-models dna_r10.4.1_e8.2_400bps_hac \
    $MODEL \
    reads.pod5 > basecalls.bam

# Convert to fastq
samtools fastq basecalls.bam > reads.fastq
```

**Notes:**
- Ensure sufficient GPU memory (recommended 24GB+)
- Use --emit-moves to preserve modification information
- High modification model significantly increases runtime

---

### 02_alignment.sh

Sequence alignment script, maps reads to reference genome.

**Parameters:**
| Parameter | Description |
|-----------|-------------|
| `$1` | Input fastq file |
| `$2` | Reference genome |
| `$3` | Output bam file |

**Command Example:**
```bash
minimap2 -ax map-ont \
    -t 16 \
    genome.fa \
    reads.fastq | \
    samtools sort -@ 16 -o aligned.bam

# Create index
samtools index aligned.bam
```

**Key Parameters:**
| Parameter | Description | Recommended |
|-----------|-------------|-------------|
| `-ax map-ont` | Mode: ONT long reads | - |
| `-t` | Thread count | 16-32 |
| `-K` | Batch size | 1G |
| `--MD` | Record MD tags | - |

**Notes:**
- Use `-ax map-ONT` not `map-ont`
- Must index bam file
- MD tags recommended for downstream analysis

---

### 03_modkit_pileup.sh

m6A modification site analysis script.

**Parameters:**
| Parameter | Description |
|-----------|-------------|
| `$1` | Input bam file |
| `$2` | Reference genome |
| `$3` | Output directory |

**Command:**
```bash
modkit pileup \
    aligned.bam \
    output_dir \
    --ref genome.fa \
    --threads 16 \
    --cpg \
    --mod-threshold 0.1
```

**Key Parameters:**
| Parameter | Description | Recommended |
|-----------|-------------|-------------|
| `--ref` | Reference genome | (required) |
| `--threads` | Thread count | 16 |
| `--cpg` | Analyze CpG sites | - |
| `--mod-threshold` | Minimum modification frequency | 0.1 |
| `--prefix` | Output file prefix | - |

**Output Files:**
- `modkit_pileup.csv` - Modification site list
- `modkit_pileup.stats` - Statistics

## Common Issues

### 1. Basecalling Too Slow

**Causes:**
- Insufficient GPU performance
- Model too large
- Too many small pod5 files

**Solutions:**
```bash
# Use faster mode
dorado basecaller --fast $MODEL reads.pod5 > fastq

# Batch processing
ls *.pod5 | xargs -I{} dorado basecaller $MODEL {} > {}.fastq
```

### 2. Modification Detection Failed

**Check:**
```bash
# Confirm MM tags exist
samtools view aligned.bam | grep -c "MM:Z:"

# Check modkit version
modkit --version
```

**Solutions:**
- Use modification-supported model
- Ensure --emit-moves parameter is used

### 3. Modification Frequency Too Low

**Cause Analysis:**
- Coverage too low
- Threshold too high
- Few modifications in sample

**Adjustment:**
```bash
# Lower threshold
modkit pileup input.bam output --mod-threshold 0.05

# Increase coverage requirement
modkit pileup input.bam output --min-coverage 20
```

### 4. Out of Memory

**Solutions:**
```bash
# Reduce thread count
minimap2 -t 8 ...

# Batch processing
split -l 10000 reads.fastq reads_chunk_
for f in reads_chunk_*; do minimap2 ... $f; done
```

### 5. BAM File Too Large

**Solutions:**
```bash
# Use CRAM format
samtools view -C aligned.bam -o aligned.cram

# Compress
samtools sort -@ 16 -o aligned.sorted.bam aligned.bam
samtools index aligned.sorted.bam
```

## Result Interpretation

### Modification Frequency Distribution

```bash
# Statistics of modification frequency
awk -F',' 'NR>1 {print $6}' m6A_sites.csv | \
    sort | uniq -c | sort -k2 -n
```

### Coverage Distribution

```bash
# Statistics of different coverage ranges
awk -F',' 'NR>1 {if($7>100) print "high"; else if($7>50) print "med"; else print "low"}' \
    m6A_sites.csv | sort | uniq -c
```

### Conservative Motif Analysis

```bash
# Extract motif distribution
awk -F',' 'NR>1 {print $9}' m6A_sites.csv | \
    sort | uniq -c | sort -rn | head -10
```

## Validation and Optimization

### Compare with Other Methods

Can compare results with:
- **MeRIP-seq**: Traditional m6A detection method
- **m6A-seq**: Immunoprecipitation method
- **SCARLET**: Single-molecule validation

### Parameter Optimization

```bash
# Higher precision
modkit pileup input.bam output \
    --mod-threshold 0.2 \
    --min-coverage 30 \
    --refine-boundaries

# Balance precision and coverage
modkit pileup input.bam output \
    --mod-threshold 0.1 \
    --min-coverage 20
```

## Citation

- **Dorado**: Oxford Nanopore Technologies. https://github.com/nanoporetech/dorado
- **modkit**: Foundation for Applied Bioinformatics. https://github.com/nanoporetech/modkit
- **minimap2**: Li H. (2018). Minimap2: pairwise alignment for genomic sequences. Journal of Computational Biology.

## License

MIT License

## Contact

For issues: https://github.com/IceBear321/Nanopore_m6A_Detection/issues
